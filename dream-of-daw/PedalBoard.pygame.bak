# import sounddevice as sd
from pedalboard import load_plugin
# from pedalboard.io import AudioStream
from mido import Message  # not part of Pedalboard, but convenient!
# import threading
# import copy
import queue


SAMPLE_RATE = 48000
BUFFER_SIZE = 128
SYNTH_PLUGIN = "./Wt Synth.vst3"  # .dll, .vst3, .vst, .component
# .dll, .vst3, .vst, .component
# SYNTH_PLUGIN = "/home/yogurt/.vst3/Wt Synth.vst3"
# print(f"plugin params = {instrument.parameters.keys()}")

# output_dev = AudioStream.output_device_names
# print(f"output dev: {output_dev}")
# Get the name of the default output device
# print(f"Default output device name: {output_dev}")


print("before load")
instrument = load_plugin(SYNTH_PLUGIN)
print("plugin load")

output_dev = sd.query_devices()[0]
SAMPLE_RATE = output_dev['default_samplerate'] if output_dev['default_samplerate'] else SAMPLE_RATE


q = queue.Queue()
midi_cmds = []
SENTINEL = object()


def callback(outdata, frames, time, status):
    cmds = []

    cmds = [q.get_nowait() for _ in range(q.qsize())]

    if cmds:
        print(cmds)
        q.task_done()

    outdata[:frames] = instrument(
        cmds,
        duration=frames/SAMPLE_RATE,
        sample_rate=SAMPLE_RATE,
        buffer_size=frames,
        num_channels=1,
        reset=False,
    ).reshape((frames, 1))


def play():
    from time import sleep

    print("... playing ...")
    stream = sd.OutputStream(
        samplerate=SAMPLE_RATE,
        device=output_dev['name'],
        channels=1,
        callback=callback,
    )

    with stream:
        q.put(Message("note_on", note=60))
        sleep(3)
        q.put(Message("note_off", note=60))
        sleep(3)

        input("Press enter to stop streaming...")


if __name__ == "__main__":
    play()
